# Telegram Bot Channel Utils

This project is a Telegram bot that, in the future, will be able to generate heatmaps for any financial asset and compose an image with it combined
with the candlestick data for that asset. The updates can be posted on a time basis to telegram channels, configurable by user input, or generated
on-demand by interacting with the bot manually or by using a command in a channel.

## Current features

- Listens for configuration commands from the telegram channels it's in.
- Registers individual pair lists and timeframes for each of those pairs, set separately and independently for each channel.
- Has logging capabilities for the messages it receives and other updates, configurable via the `logger.py` module.
- Periodically sends liquidation heatmap charts to each channel, with the selected pair list.
- Has two modes of operation, adjustable independently for each channel, "sequential" and "simultaneous". Refer to changelogs for `ver b0.5` to read
  more.

## Requirements

- Python 3.12
- The requirements in `requirements.txt`

## Installation

1. Clone the repository:
    ```sh
    git clone https://github.com/thewitcher745/heatmap-bot
    cd telegram-bot-channel-utils
    ```

2. Install the required dependencies:
    ```sh
    pip install -r requirements.txt
    ```

3. Set up your bot token in a `.env.secret` file, located in the root:
    ```python
    BOT_TOKEN = 'your-telegram-bot-token'
    ```
4. Launch the project by running `python main.py` in the project root directory.

5. Add the bot to your desired channel through Telegram.

6. Use the various commands to interact with the bot.

## Project Structure

- `channel/channel_utils.py`: Utility script for handling things related to channel messages.
- `channel/scheduler_utils.py`: Classes and functions related to job scheduling and resuming features.
- `channel/handlers.py`: Command handlers for the channel.
- `utils/logger.py`: Logger utility for logging messages.
- `utils/config_manager.py`: Independent channel config management functions
- `utils/latest_update_manager.py`: Utilities related to finding and using the latest update made to a channel.
- `data/`: Directory for things related to the image generation, handling data, etc. The numbers, Mason!
- `data/chart.py`: Module for creating (webscraping, currently) the charts for one of more pairs in bulk.
- `logs/`: Directory for the logs generated by the bot.
- `output_images/`: Directory for the output images generated by the bot.
- `constants.py`: Contains the constants that make the bot work.

## Bot commands

- `/init`: Manually initiate a channel's config. This is usually unnecessary since it is initiated when adding pairs or changing any other settings.
- `/addpair`: Adds a pair to the list of pairs for the channel. (Requires restart to take effect)
- `/removepair`: Removes a pair from the list of pairs for the channel. (Requires restart to take effect)
- `/showpairs`: Shows the list of pairs added to the channel.
- `/setinterval`: Sets the interval for the bot to send messages to the channel. (Requires restart to take effect)
- `/currentchart`: Generates a heatmap for the selected pair list and sends it to the channel.
- `/setmode`: Sets the mode for each channel. Can be "sequential" or "simultaneous". (Requires restart to take effect)
- `/setpairinterval`: Sets the interval between each pair's chart in the "sequential" mode. (Requires restart to take effect)

## Changelog

### ver b0.1

- Implemented rudimentary candlestick charting utility in `data/plotting.py`
- Implemented basic logging utility in `utils/logger.py`
- Implemented basic channel message handling utility in `channel/channel_utils.py`. This will be expanded upon majorly in the future.

### ver b0.2

- Implemented config file reading and writing in `utils/config_manager.py`
- Implemented periodic message sending, later to be updated with the actual images.
- Added commands to add pairs to and show the list of pairs (/addpair and /showpairs) and a command to adjust the posting interval (/setinterval) for
  each channel.
- Updated get_candlestick to get_pair_data and cleaned up its code

### ver b0.3

- Completely changed how the chart is made. Now screenshots the heatmap from a website, after selecting the pair from the website GUI by webscraping.
  First the website is loaded, then the chart is scrolled into view, then the whole website gets screenshotted before being cropped using PIL.
- Added a command to generate the liquidation heatmap on-demand (/currentchart).
- Removed timeframe setting for the pairs, since the website does not offer timeframe selection.

### ver b0.4

- Images are now produced in batches and in bulk, if the argument given to the `Chart.__init__` method is a list. If it isn't, the image is produced
  normally.
- Queuing the chart sending is now done on the basis of 00:00:00 UTC, hence it doesn't matter when the bot is started, the images always get send at a
  fixed time during the day, which is 1 second after any time, the difference of which to the 00:00:00 UTC time is divisible by the interval. So a 4h
  interval would send images at 00:00:01, 04:00:01, 08:00:01, etc.
- Modularized and cleaned up app.py, moved the job queue and other functions to different `channel_utils.py` module.

### ver b0.5

- Added pair removal and disallowed repeated pair adding.
- Added mode distinction, settable independently and separately for each channel using the `/setmode <mode>` command, where \<mode\> is either "
  sequential" or "simultaneous".
- The default for every channel is the "simultaneous" mode which sends all charts at the same time, spaced by "posting_interval" seconds. The other
  mode, "sequential", will not send all the charts at the same time and in bulk, instead it has another defined interval, called "pair_interval",
  which makes it so that the chart for each pair are sent separately, spaced by "pair_interval" seconds. The pair interval and the modes are
  adjustable using commands.
- The "posting_interval" determines where the cycle restarts, so it is always necessarily and implicitly greater than or equal to the product of the
  number of pairs and the pair_interval.
- Added a full-fledged resume feature, which in the case of sequential mode, has great importance. Without this feature, the bot would only start the
  sequential cycles at the "posting_interval" times, and would skip over any possible pairs that would have been posted if the bot had been running
  since the last posting time.
- A great many number of bugfixes and small QoL improvements and code modularization